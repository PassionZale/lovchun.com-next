---
title: 'JS 中的二进制'
createdAt: '2022-08-17'
publishedAt: '2022-08-21'
updatedAt: '2022-08-21'
draft: false
toc: false
summary: 'ArrayBuffer、Blob、File、FileReader'
tags: ['指南']
components: ['Base64']
---

## 原生 Base64 编码和解码

从 IE10+浏览器开始，所有浏览器就原生提供了 Base64 编码解码方法，不仅可以用于浏览器环境，Service Worker 环境也可以使用。

它们就是 `atob` 和 `btoa`:

- `a` 表示 Base64 字符串
- `b` 表示 普通字符串

```js
window.btoa('lovchun.com') // bG92Y2h1bi5jb20=

window.atob('bG92Y2h1bi5jb20=') // lovchun.com
```

## FileReader

在实际开发过程中，Base64 经常会用于处理图片的预览、上传、下载等。

### 选择图片后获取 Base64

<Base64 />

- FileReader 结合 input[type="file"]

```js
function previewFile() {
  var preview = document.querySelector('img')
  var file = document.querySelector('input[type=file]').files[0]
  var reader = new FileReader()

  if (file) {
    // readAsDataURL 方法会读取指定的 Blob 或 File 对象
    // 读取操作完成的时候
    // readyStatus 变为 DONE

    reader.readAsDataURL(file)
  }

  // readAsDataURL
  // 读取操作完成的时候
  // 会触发 loaded 事件
  //   推荐使用 addEventListener() 来注册一个事件监听器，理由如下：

  // 它允许为一个事件添加多个监听器。特别是对库、JavaScript 模块和其他需要兼容第三方库/插件的代码来说，这一功能很有用。
  // 相比于 onXYZ 属性绑定来说，它提供了一种更精细的手段来控制 listener 的触发阶段。（即可以选择捕获或者冒泡）。
  // 它对任何事件都有效，而不仅仅是 HTML 或 SVG 元素。
  reader.addEventListener(
    'load',
    function () {
      preview.src = reader.result // base64 data:image/png;base64,XXXX
    },
    false
  )

  // 或
  reader.onload = function () {
    preview.src = reader.result // base64 data:image/png;base64,XXXX
  }
}
```

- 原生的 base64 编码和解码 => atob & btoa

a => base64
b => 普通字符串

```js
window.btoa('lovchun.com') // bG92Y2h1bi5jb20=

window.atob('bG92Y2h1bi5jb20=') // lovchun.com
```

- base64ToBlob

```js
function convertBase64ImageData(base64Url) {
  const arr = base64Url.split(',')

  const [metaData, base64Data] = arr

  const contentType = metaData.match(/:(.*?);/)[1]

  return {
    base64Data,
    contentType,
  }
}

function base64ToBlob(base64Data, contentType = '') {
  const byteCharacters = atob(base64Data)
  const byteArrays = []
  let { length } = byteCharacters

  const byteArray = new Uint8Array(length)

  while (length--) {
    byteArray[n] = byteCharacters.charCodeAt(n)
  }

  const blob = new Blob([byteArray], { type: contentType })

  return blob
}
```

- downloadBlob

```js
const downloadBlob = (blob, filename) => {
  if (window.navigator && window.navigator.msSaveOrOpenBlob) {
    // for IE
    window.navigator.msSaveOrOpenBlob(blob, filename)
    return
  }

  let downloadLink = document.createElement('a')
  let downloadURL = URL.createObjectURL(blob)

  downloadLink.href = downloadURL
  downloadLink.download = filename
  downloadLink.click()

  setTimeout(() => {
    downloadLink = null
    URL.revokeObjectURL(downloadURL)
    downloadURL = null
  }, 1000)
}
```

- TODO load image

https://gist.github.com/santisbon/a7c221780b528bd3ebb8
