---
title: '构建 Vue3 组件库 - 组件'
createdAt: '2023-11-27'
publishedAt: '2023-11-27'
updatedAt: '2023-11-27'
toc: false
draft: false
summary: '我对组件注册原理、目录设计、文件拆分的一些看法。'
tags: ['指南', 'Vue.js']
components: ['Tree']
---

> 构建 Vue3 组件库系列，只是单纯记录与分享我开发组件库过程中有意思的思路、设计等，
>
> 它没有办法**手把手教你搭建**，因为这需要你自己来实践，
>
> 同样，我的实践，不一定是最适合你的，你需要通过实践来拥有适合自己的**最佳实践**，
>
> 如果对你有任何帮助，我会很开心。 :tada:
>
> 通过下方的[**目录**](#目录)可以快速浏览整个专题，
>
> 通过下方的[**源码**](#源码)可以查看原始代码和文档实例。

## 目录

- [**《构建 Vue3 组件库 - 如何开始》**](/posts/setup-vue3-component-library/how-to-start)
- [**《构建 Vue3 组件库 - 安装依赖》**](/posts/setup-vue3-component-library/install-deps)
- [**《构建 Vue3 组件库 - 图标》**](/posts/setup-vue3-component-library/svg-icon)
- [**《构建 Vue3 组件库 - 组件》**](/posts/setup-vue3-component-library/sfc)
- [**《构建 Vue3 组件库 - 样式》**](/posts/setup-vue3-component-library/css)
- [**《构建 Vue3 组件库 - 调试》**](/posts/setup-vue3-component-library/debug)
- [**《构建 Vue3 组件库 - 打包》**](/posts/setup-vue3-component-library/build)
- [**《构建 Vue3 组件库 - 文档》**](/posts/setup-vue3-component-library/doc)

## 源码

- [代码仓库](https://github.com/passionzale/geist-design)
- [在线预览](https://geist-design.lovchun.com)

## 组件注册

对于使用者来说，组件库可以批量导入，也可以单个导入，例如：

```ts:main.ts
// 批量导入
import { createApp } from 'vue'
import App from './App.vue'
import GeistDesign from '@whouu/geist-design'

createApp(App).use(GeistDesign).mount('#app')

// 单个导入
import { createApp } from 'vue'
import App from './App.vue'
import { GAvatar, GButton } from '@whouu/geist-design'

createApp(App).use(GAvatar).use(GButton).mount('#app')
```

### app.use()

参考 [官方文档](https://cn.vuejs.org/api/application.html#app-use)，`app.use()` 需要传递一个带 `install()` 方法的对象。

**组件的入口文件：**

```ts:src/avatar/index.ts {4}
import Avatar from "./avatar.vue"

export const GAvatar = () => {
  Avatar.install = () => {}

  return Avatar
}

export default GAvatar
```

**组件库的入口文件：**

```ts:src/index.ts {1}
const install = () => {}

export default { install }
```

### app.component()

> 正是因为要通过 `app.component()` 注册组件，组件的名称尤其重要，参考 [此处](/posts/setup-vue3-component-library/install-deps#vue)

在上面两个 `install` 方法中，我们调用 `app.component()` 将组件库中的组件注册到使用者的 Vue 实例中。

**组件的入口文件：**

每一个组件都需要 `installWrapper`，因此单独提取该方法:

```ts:src/_utils/index.ts
import type { App, Directive, Component } from 'vue'

export type Install<T> = T & {
  install(app: App): void
}

/**
 * 注册组件
 *
 * @param { Object } main 组件实例
 * @returns { Object } 组件实例
 */
export const withInstallComponent = <T extends Component>(main: T): Install<T> => {
  (main as Record<string, unknown>).install = (app: App): void => {
    const { name } = main
    name && app.component(name, main)
  }
  return main as Install<T>
}
```

```ts:src/avatar/index.ts {4}
import Avatar from "./avatar.vue"
import { withInstallComponent } from '@/_utils'

export const GAvatar = withInstallComponent(Avatar)

export default GAvatar
```

**组件库的入口文件：**

```ts:src/index.ts {5-11}
import * as components from './components'

import type { App } from 'vue'

const install = (app: App): App => {
  Object.entries(components).forEach(([key, value]) => {
    app.component(key, value)
  })

  return app
}

export default { install }
```

## 目录结构

为了更好的维护和导出 `props` 的类型文件，将 `props` 单独抽离成一个 `.ts` 文件，`emits` 同理。

<Tree data={SFCStructure} />

在[官方文档](https://cn.vuejs.org/guide/typescript/composition-api.html#typing-component-props)中，定义一个带有默认值的 props，大概是这样：

```html:avatar.vue
<script setup lang="ts">
  export interface Props {
    msg?: string
    labels?: string[]
  }

  const props = withDefaults(defineProps<Props>(), {
    msg: 'hello',
    labels: () => ['one', 'two']
  })
</script>
```

如何将 `withDefaults` `defineProps` `Props`，三者抽离到 `props.ts` 中，并像这样使用：

```html:avatar.vue
<script setup lang="ts">
  import { Props } from './props'

  defineProps(Props)
</script>
```

参考[复杂的 prop 类型](https://cn.vuejs.org/guide/typescript/composition-api.html#complex-prop-types)，结合 `PropType` 和 `as const`：

- 通过 `as unknown as PropType<T>` 来定义类型；
- 使用 `as const` 让 `props` 只读；

```ts:props.ts
import type { PropType } from 'vue'

export const props = {
  booleanProp: Boolean,
  stringNumberBooleanProp: {
    type: [String, Number, Boolean] as unknown as PropType<string | number | boolean>,
    default: false
  },
  complexArrayProp: {
    type: Array as unknow as PropType<(string | number | boolean)[]>,
    default: () => []
  }
  enumStringProp: {
    type: String as unknown as PropType<'large' | 'medium' | 'normal' | 'small'>,
    default: 'normal'
  }
} as const
```

## ExtractPropTypes

某些场景，可能需要在 ts 中组装组件的 props，而后直接使用 `v-bind` 进行传递：

```html:example.vue
<script setup lang="ts">
  /**
   * 此时 ts 无法进行静态类型检查，
   * 你也不清楚自己写的 props 是否和开发者定义的是否匹配
   */
  const avatarProps = {}
</script>

<template>
  <g-avatar v-if="avatarProps" v-bind="avatarProps" />
</template>
```

在 props.ts 中，使用 `ExtractPropTypes` 导出 SFC props 类型：

```diff:props.ts
+ import type { ExtractPropTypes, PropType } from 'vue'

export const props = {
  booleanProp: Boolean,
  stringNumberBooleanProp: {
    type: [String, Number, Boolean] as unknown as PropType<string | number | boolean>,
    default: false
  },
  complexArrayProp: {
    type: Array as unknow as PropType<(string | number | boolean)[]>,
    default: () => []
  }
  enumStringProp: {
    type: String as unknown as PropType<'large' | 'medium' | 'normal' | 'small'>,
    default: 'normal'
  }
} as const

+ export type AvatarProps = ExtractPropTypes<typeof Props>
```

再回到 `example.vue`：

```diff:example.vue
<script setup lang="ts">
+  import type { AvatarProps } from '@whouu/geist-design'

+  const avatarProps: AvatarProps = { size: 'medium' }
</script>

<template>
  <g-avatar v-if="avatarProps" v-bind="avatarProps" />
</template>
```

export const SFCStructure = [
  {
    type: 'folder',
    name: 'avatar',
    expand: true,
    childrens: [
      {
        type: 'folder',
        name: '__test__',
        expand: true,
        childrens: [
          { type: 'file', name: 'description.spec.ts', icon: 'ts' }
        ]
      },
      {
        type: 'folder',
        name: 'src',
        expand: true,
        childrens: [
          { type: 'file', name: 'avatar.vue' },
          { type: 'file', name: 'interface.ts' },
          { type: 'file', name: 'props.ts' },
          { type: 'file', name: 'emits.ts', help: '如果有自定义事件' },
        ]
      },
      {
        type: 'file',
        name: 'index.ts'
      }
    ]
  }

]
