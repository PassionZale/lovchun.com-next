---
title: 'Setup Miniprgram - PART 2'
createdAt: '2022-07-01'
publishedAt: '2022-07-01'
updatedAt: '2022-07-01'
toc: true
draft: false
summary: 'å¼‚å¸¸ã€é€šè®¯ã€æŠ€å·§'
tags: ['guide']
---

<Image
  src={'/static/images/setup-miniprogram/banner.jpeg'}
  width={1417}
  height={667}
  alt="æ¶æ„ã€æ¡†æ¶ã€ç»„ä»¶"
/>

> - [ã€ŠSetup Miniprgram - PART 1ã€‹](/posts/setup-miniprogram/part-1)
>
>   - VSCode æ’ä»¶ã€ç›®å½•è®¾è®¡ã€å¾®ä¿¡å¼€å‘è€…å·¥å…·ã€é…ç½®æ–‡ä»¶ã€Packages
>
> - :rainbow: [ã€ŠSetup Miniprgram - PART 2ã€‹](/posts/setup-miniprogram/part-2)
>
>   - å¼‚å¸¸ã€é€šè®¯ã€æŠ€å·§
>
> - [ã€ŠSetup Miniprgram - PART 3ã€‹](/posts/setup-miniprogram/part-3)
>
>   - TODO
>
> - [ã€ŠSetup Miniprgram - PART 4ã€‹](/posts/setup-miniprogram/part-4)
>
>   - TODO
>
> - [ã€ŠSetup Miniprgram - PART 5ã€‹](/posts/setup-miniprogram/part-5)
>   - TODO

## å¼‚å¸¸

è”è°ƒæ¥å£æ—¶ï¼Œé€šå¸¸åç«¯ä¼šæœ‰ä¸€å¥—é€šç”¨çš„ `ResponseDTO`:

```ts
interface IBaseResponse<T = any> {
  /**
   * ä¸šåŠ¡çŠ¶æ€ç 
   */
  code: number
  /**
   * å“åº”æ•°æ®
   */
  data: T
  /**
   * å“åº”æ¶ˆæ¯
   */
  message: string
  /**
   * å“åº”æ—¶é—´æˆ³
   */
  timestamp: number
  /**
   * è‡ªå®šä¹‰å±æ€§ï¼Œå¦‚: path: string
   */
  [propName: string]: any
}
```

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæœ‰æŸäº›åœºæ™¯ï¼ŒæœŸæœ› `Promise` æˆ–è€… `async function` æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼š

```js
throw new Error('è¯·æ±‚å¤±è´¥')
// æˆ–
return Promise.reject('è¯·æ±‚å¤±è´¥')
```

ä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼‚å¸¸å’Œ API çš„è¿”å›æ•°æ®ç»“æ„ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å°è£…ä¸€ä¸ª**è‡ªå®šä¹‰å¼‚å¸¸**è¿›è¡Œç»Ÿä¸€:

### CustomException

```js
const EXCEPTION_ERROR_MESSAGE = 'ç½‘ç»œå¼€å°å·®~'

/**
 * è‡ªå®šä¹‰å¼‚å¸¸, æ•°æ®ç»“æ„ä¸ IBaseResponse ç›¸ä¼¼
 * {
 *  "code": => å¯é€‰å­—æ®µï¼Œé 200 çš„æ•´æ•°ï¼Œé»˜è®¤ä¸º 5000
 *  "data": => å¯é€‰å­—æ®µï¼Œç”¨äºè‡ªå®šä¹‰æ•°æ®
 *  "message" => å¿…å¡«å­—æ®µï¼Œç”¨äºé”™è¯¯åŸå› è¯´æ˜
 *  "timestamp" => é»˜è®¤å¡«å…… å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 *  "name" => é»˜è®¤å¡«å…… 'CustomException'
 * }
 */
class CustomException {
  constructor({ code = 5000, data, message }) {
    this.code = code
    this.data = data
    this.message = message || EXCEPTION_ERROR_MESSAGE
    this.timestamp = +new Date()
    this.name = 'CustomException'
  }
}

// âœ…
throw new CustomException({ message: 'è‡ªå®šä¹‰é”™è¯¯' })
// âŒ
throw new Error('è¯·æ±‚å¤±è´¥')
```

### SDKException

ä½¿ç”¨å°ç¨‹åº SDK æ—¶ï¼ŒSDK æ‰€ç»™çš„ `error` æ˜¯è¿™æ ·çš„:

```json
{
  "errMsg": "openBluetoothAdapter:fail:not available",
  "errCode": 10001,
  "errno": 1500102
}
```

å’Œ `IBaseResponse` åˆæœ‰å¾ˆå¤§çš„å·®å¼‚ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å°è£…ä¸€ä¸ª**SDK å¼‚å¸¸**è¿›è¡Œç»Ÿä¸€:

```js
const EXCEPTION_ERROR_MESSAGE = 'ç½‘ç»œå¼€å°å·®~'

/**
 * è‡ªå®šä¹‰å¾®ä¿¡æˆ–ä¼å¾® SDK å¼‚å¸¸
 * https://developers.weixin.qq.com/miniprogram/dev/framework/usability/PublicErrno.html
 * {
 *  "errMsg": "openBluetoothAdapter:fail:not available",
 *  "errCode": 10001,
 *  "errno": 1500102,
 *  "code": => å¯é€‰å­—æ®µï¼Œé 200 çš„æ•´æ•°ï¼Œè‹¥è®¾ç½®äº†å€¼ï¼Œ"errno" å’Œ "errCode" ä¼šå¤±æ•ˆ
 *  "data": => å¯é€‰å­—æ®µï¼Œç”¨äºè‡ªå®šä¹‰æ•°æ®
 *  "message": => å¯é€‰å­—æ®µï¼Œç”¨äºæ•è·å…¶ä»– js é”™è¯¯ï¼Œæˆ–è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯
 *  "timestamp" => é»˜è®¤å¡« å……å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 *  "name" => é»˜è®¤å¡«å…… 'SDKException'
 * }
 */
class SDKException {
  constructor({ errMsg, errCode, errno, code, message, data }) {
    this.code = code || errno || errCode || 5000
    this.data = data
    this.message = message || errMsg || EXCEPTION_ERROR_MESSAGE
    this.timestamp = +new Date()
    this.name = 'SDKException'
  }
}
```

### å¼‚å¸¸æ¥æº

**é€šè¿‡`instanceof`åˆ¤æ–­ï¼ˆğŸ‘ æ¨èï¼‰**

```js
async function foo() {
  try {
    await bar()
  } catch (exception) {
    if (exception instanceof CustomException) {
      // æ˜¯æˆ‘çš„è‡ªå®šä¹‰å¼‚å¸¸
    } else {
      // ä¸æ˜¯æˆ‘çš„è‡ªå®šä¹‰å¼‚å¸¸ <= Uncaught ReferenceError: bar is not defined
    }
  }
}
```

**é€šè¿‡`name`åˆ¤æ–­**

```js
async function foo() {
  try {
    await bar()
  } catch (exception) {
    if (exception.name === 'CustomException') {
      // æ˜¯æˆ‘çš„è‡ªå®šä¹‰å¼‚å¸¸
    } else {
      // ä¸æ˜¯æˆ‘çš„è‡ªå®šä¹‰å¼‚å¸¸ <= Uncaught ReferenceError: bar is not defined
    }
  }
}
```

### :zap: é¢å¤–å°å¿ƒ

å°ç¨‹åºçš„ SDK æ¯”è¾ƒä¼šè¿”å›æ‰€æœ‰çš„é”™è¯¯ï¼Œ**åŒ…æ‹¬å–æ¶ˆ**ï¼Œåœ¨æ•è· `SDKException` éœ€è¦è¿‡æ»¤æ‰è¿™ç±»åœºæ™¯:

```js {12,13}
/**
 * æ‹¨æ‰“ç”µè¯
 * @param {string} phoneNumber ç”µè¯å·ç 
 */
export async function makePhoneCall(phoneNumber) {
  if (typeof phoneNumber !== 'string')
    throw new SDKException({ message: 'phoneNumber must be string' })

  try {
    await wx.makePhoneCall({ phoneNumber })
  } catch (error) {
    // exclude "å–æ¶ˆ" çš„åœºæ™¯
    if (!error.errMsg || error.errMsg.indexOf('fail cancel') === -1) {
      wx.showToast({ title: error.errMsg, icon: 'none' })

      throw new SDKException(error)
    }
  }
}
```

## é€šè®¯

### queryParams

> **pageA** `navigateTo` **pageB** ï¼ˆæœ€åŸºæœ¬çš„é€šè®¯æ–¹å¼ï¼‰

```js:pageA.js
Page({
  methods: {
    handleTap() {
      wx.navigateTo({ url: `pageB?foo=bar` })
    }
  }
})
```

```js:pageB.js
Page({
  onLoad(options) {
    const { foo } = options // <== foo is 'bar'
  }
})
```

### variableStorage

> **orderList** set data, **orderDetail** get dataï¼ˆé€‚åˆä¸€æ¬¡æ€§é€šè®¯å¤æ‚çš„æ•°æ®ç»“æ„ï¼‰

#### å®šä¹‰ storage class

```js:_shared/helpers/storage.js
/**
 * Storage
 *
 * @desc      å†…å­˜å­˜å‚¨ï¼Œä¸»è¦ç”¨äºè·¨é¡µé¢å‚æ•°çš„ä¼ é€’
 */

import { CustomException } from './utils'

class Storage {
  constructor(options) {
    const { snapchat = false } = options || {}

    this.snapchat = snapchat
    this.data = {}
  }

  set(key, value) {
    if (!key) {
      throw new CustomException({ message: 'key ä¸èƒ½ä¸ºç©º' })
    }

    this.data[String(key)] = value
  }

  get(key) {
    const value = key ? this.data[String(key)] : this.data

    if (this.snapchat) {
      this.removeItem(key)
    }

    return value
  }

  removeItem(key) {
    delete this.data[String(key)]
  }

  clear() {
    this.data = {}
  }
}

export default Storage
```

#### å®šåˆ¶ä¸“å± store

```js:_shared/stores/order.js {3,4,16,17}
import Storage from '../helpers/storage'

// ä¿è¯æ¯ä¸ª store module éƒ½æ˜¯å…¨æ–°çš„ Storage å®ä¾‹
const storage = new Storage({ snapchat: true })

class Store {
  get orderSourceData() {
    return storage.get('data')
  }

  set orderSourceData(val) {
    storage.set('data', val)
  }
}

// å¯¼å‡º Order Store å®ä¾‹
export default new Store()
```

```js:orderList.js {10-12}
import OrderStore from '@/_shared/stores/order'
import { useRequest } from '@/_shared/helpers/request'

Page({
  methods: {
    async handleDetail({ currentTarget: { dataset: { orderNo }}}) {
      const [err, res] = await useRequest('api/v1/order/detail', { orderNo })

      if(!err) {
        // å†™å…¥ orderSourceData
        OrderStore.orderSourceData = this.data.orders[index]
        wx.navigateTo({ url: `orderDetail` })
      } else {
        // error handler
      }
    }
  }
})
```

```js:orderDetail.js {5,6}
import OrderStore from '@/_shared/stores/order'

Page({
  onLoad() {
    // è¯»å– orderSourceData
    const data = OrderStore.orderSourceData
  }
})
```

### å‘å¸ƒè®¢é˜…

> pageA `navigateTo` pageB ï¼ˆ**å…ˆè®¢é˜…åå‘å¸ƒ**ï¼‰

#### eventBus

æœ‰å¾ˆå¤šå®ç°æ–¹å¼ï¼Œè¿™é‡Œç®€å•å±•ç¤ºé¡¹ç›®ä¸­ä½¿ç”¨çš„æ¨¡å—ç¤ºä¾‹ï¼š

```js:_shared/helpers/eventBus.js
const notices = []

// æ³¨å†Œé€šçŸ¥
export function on(name, observer, selector) {
  if (name && observer && selector) {
    const newNotice = {
      name,
      observer,
      selector
    }

    add(newNotice)
  }
}

// ç§»é™¤é€šçŸ¥ï¼ˆobserveræŒ‰nameï¼‰
export function off(name, observer) {
  wx.nextTick(() => {
    // ä»¥é˜²postè¿‡ç¨‹ä¸­åŒæ—¶remove
    for (let i = notices.length - 1; i >= 0; i--) {
      const inNotice = notices[i]

      if (inNotice.name == name && inNotice.observer == observer) {
        notices.splice(i, 1)
      }
    }
  })
}

// ç§»é™¤é€šçŸ¥ï¼ˆobserveræ‰€æœ‰ï¼‰
export function clean(observer) {
  wx.nextTick(() => {
    // ä»¥é˜²postè¿‡ç¨‹ä¸­åŒæ—¶remove
    for (let i = notices.length - 1; i >= 0; i--) {
      const inNotice = notices[i]

      if (inNotice.observer == observer) {
        notices.splice(i, 1)
      }
    }
  })
}

// å‘é€é€šçŸ¥
export function emit(name, info) {
  for (let i = 0; i < notices.length; i++) {
    const inNotice = notices[i]

    if (inNotice.name == name) {
      inNotice.selector(info)
    }
  }
}

// åŠ å…¥é€šçŸ¥æ•°æ®
function add(newNotice) {
  if (notices.length > 0) {
    for (let i = 0; i < notices.length; i++) {
      const inNotice = notices[i]

      if (
        inNotice.name == newNotice.name &&
        inNotice.selector == newNotice.selector &&
        inNotice.observer == newNotice.observer
      ) {
        return
      }
    }
  }

  notices.push(newNotice)
}
```

#### eventKeys

**ä¸è¦ä½¿ç”¨é­”æ³•å­—ç¬¦**ï¼Œä½¿ç”¨**å¸¸é‡**ï¼š

```js:@/_shared/constants/eventKeys.js
/**
 * è®¢å•å·²æ“ä½œï¼Œä¾‹å¦‚ï¼šå–æ¶ˆã€æ”¯ä»˜ã€ç”³è¯·å”®åç­‰
 */
export const ORDER_OPERATED = 'orderOperated'
```

#### è®¢é˜…äº‹ä»¶

**å…ˆè®¢é˜…ï¼ˆorderList åœ¨ orderDetail ä¹‹å‰ï¼‰**

```js:orderList.js {5,7,14,16}
import * as eventBus from '@/_shared/helpers/eventBus'
import * as eventKeys from '@/_shared/constants/eventKeys'

Page({
  // è‹¥åœ¨ Component ä¸­ä½¿ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸º attached
  onLoad() {
    eventBus.on(eventKeys.ORDER_OPERATED, this, (payload) => {
      console.log(payload) // <= { foo: 'bar' }

      this.reloadData()
    })
  },

  // è‹¥åœ¨ Component ä¸­ä½¿ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸º detached
  unUnload() {
    eventBus.clean(this)
  }
})
```

**åå‘å¸ƒï¼ˆorderDetail åœ¨ orderList ä¹‹åï¼‰**

```js:orderDetail.js {12-16}
import * as eventBus from '@/_shared/helpers/eventBus'
import * as eventKeys from '@/_shared/constants/eventKeys'

Page({
  methods: {
    async handleCancel() {
      const { orderNo } = this.data

      const [err, res] = await useRequest('api/order/cancel', { orderNo })

      if(!err) {
        eventBus.emit(
          eventKeys.ORDER_OPERATED,
          // â†“â†“â†“â†“ any paylod you want to pass â†“â†“â†“â†“
          { foo: 'bar' }
        )
      }
    }
  }
})
```

## æŠ€å·§

### CSS Reset

```css:@/_shared/styles/reset.scss
page,
view,
scroll-view,
swiper,
swiper-item,
movable-area,
movable-view,
cover-view,
cover-image,
icon,
text,
rich-text,
progress,
button,
checkbox-group,
checkbox,
form,
input,
label,
picker,
picker-view,
radio-group,
radio,
slider,
switch,
textarea,
navigator,
functional-page-navigator,
image,
video,
camera,
live-player,
live-pusher,
map,
canvas,
open-data,
web-view,
ad {
  box-sizing: border-box;

  &::after {
    box-sizing: border-box;
  }

  &::before {
    box-sizing: border-box;
  }
}

::-webkit-scrollbar {
  width: 0;
  height: 0;
  color: transparent;
}

button {
  outline: 0;
  border: none;

  &::after {
    border: none !important;
  }
}
```

```css:@/src/app.scss
@import '@/_shared/styles/reset.scss';

page {
  background-color: $bg-color-default;
  width: 100vw;
  min-height: 100vh;
}
```

### å®‰å…¨åŒºé€‚é…

```css:@/src/app.scss
/* other stylesheet...  */

@supports (bottom: constant(safe-area-inset-bottom)) {
  .safe-area {
    padding-bottom: env(safe-area-inset-bottom);
  }
}
@supports (bottom: env(safe-area-inset-bottom)) {
  .safe-area {
    padding-bottom: env(safe-area-inset-bottom);
  }
}
```

**é¡µé¢ä¸­ä½¿ç”¨**

```html {2}
<view class="page">
  <view class="safe-area" />
</view>
```

**ç»„ä»¶ä¸­ä½¿ç”¨**

> [å¼•ç”¨é¡µé¢æˆ–çˆ¶ç»„ä»¶çš„æ ·å¼](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E5%BC%95%E7%94%A8%E9%A1%B5%E9%9D%A2%E6%88%96%E7%88%B6%E7%BB%84%E4%BB%B6%E7%9A%84%E6%A0%B7%E5%BC%8F)

```html {2}
<view class="component">
  <view class="~safe-area" />
</view>
```

### Page Enhancer

æŸäº›åœºæ™¯ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å»å¢å¼º Pageï¼Œä¾‹å¦‚ï¼š

- åœ¨æ‰€æœ‰ `Page` é‡å†™ç”Ÿå‘½å‘¨æœŸé’©å­ï¼›
- åœ¨æ‰€æœ‰ `Page` ä¸­å¡«å…… `data` å±æ€§ï¼›
- etc...

è¿˜è®°å¾— `React` ä¸­çš„ `HOC` å—ï¼Ÿ

```js
const EnhancedComponent = higherOrderComponent(WrappedComponent)
```

å‚è€ƒ `HOC`ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª `Enhancer` æ¥å¢å¼ºå°ç¨‹åºçš„ `Page` (Component åŒç†)ï¼š

```js:@/_shared/helpers/pageEnhancer.js
import * as eventBus from '@/_shared/helpers/eventBus'
import * as eventKeys from '@/_shared/constants/eventKeys'

const PageEnhancer = props => {
  // é‡å†™ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œå¹¶è®¢é˜…æŸä¸ªäº‹ä»¶
  const { onLoad, onUnload } = props

  onLoad && delete props.onLoad
  onUnload && delete props.onUnload

  props.onLoad = function() {
    eventBus.on(eventKeys.EVENT_KEY, this, (payload) => {
      // do something...
    })

    // æ‰§è¡ŒåŸæœ¬çš„ onLoad() é€»è¾‘
    onLoad && onLoad.apply(this, arguments);
  };

  props.unUnload = function() {
    eventBus.off(eventKeys.EVENT_KEY, this)

    // æ‰§è¡ŒåŸæœ¬çš„ onUnload() é€»è¾‘
    onUnload && onUnload.apply(this, arguments);
  }

  // å¡«å…… data
  props.data.foo = 'bar'

  return props
}

export default PageEnhancer
```

```js:page.js {3,11}
import PageEnhancer from '@/_shared/helpers/pageEnhancer'

const props = PageEnhancer({
  // å…¨éƒ¨çš„ Page å±æ€§
  data: { id: 1 },
  onLoad(options) {},
  onUnload() {},
  methods: {}
})

Page(props)
```

### SDK Promisify

è™½ç„¶ç°åœ¨å¤§éƒ¨åˆ† SDK æ”¯æŒ**å¼‚æ­¥**ï¼Œä½†ä»ç„¶æœ‰å°‘é‡ä¸æ”¯æŒï¼Œä¾‹å¦‚ï¼šwx.login ç­‰ï¼Œåªèƒ½ä½¿ç”¨`å›è°ƒ`å‡½æ•°çš„å½¢å¼å¤„ç† SDK çš„æˆåŠŸä¸å¤±è´¥ï¼š

```js
wx.login({
  success(res) {
    if (res.code) {
      //å‘èµ·ç½‘ç»œè¯·æ±‚
      wx.request({
        url: 'https://example.com/onLogin',
        data: {
          code: res.code,
        },
      })
    } else {
      console.log('ç™»å½•å¤±è´¥ï¼' + res.errMsg)
    }
  },
})
```

ç°åœ¨å¯¹ `wx.login` åšä¸€ä¸ª `Promise` çš„å¼‚æ­¥å°è£…ï¼š

```js
const wxLogin = () =>
  new Promise((resolve, reject) => {
    wx.login({
      success: (res) => {
        resolve(res)
      },
      fail: (err) => {
        reject(err)
      },
    })
  })
```

å¦‚æœé¡¹ç›®ä¸­ä½¿ç”¨äº† 10 ä¸ª SDK çš„è°ƒç”¨ï¼Œä»£ç å°±ä¼šå˜æˆï¼š

```js
const sdk1 = () => new Promise((resolve, reject) => {
  sdk1({
    success: () => resolve(),
    fail: () => reject()
  })
}

const sdk2 = () => new Promise((resolve, reject) => {
  sdk2({
    success: () => resolve(),
    fail: () => reject()
  })
}

const sdk3 = () => new Promise((resolve, reject) => {
  sdk3({
    success: () => resolve(),
    fail: () => reject()
  })
}

// sdk 4-10...
```

å‚ç…§ `Nodejs` ä¸­çš„ [`util.promisify(original)`](https://nodejs.org/dist/latest-v16.x/docs/api/util.html#utilpromisifyoriginal)ï¼Œå°è£…ä¸€ä¸ªç®€æ˜“çš„ `promisify()`ï¼š

```js:@/_shared/helpers/utils.js
/**
 * å°†å›è°ƒå½¢å¼çš„å‡½æ•°åšä¸€ä¸ª promise å°è£…
 * @param {*} func
 * @returns {Promise}
 */
export const promisify = fn => options =>
  new Promise((resolve, reject) => {
    fn({
      ...options,
      success: resolve,
      fail: reject
    })
  })
```

```js:@/_shared/helpers/wechat.js
import { promisify } from '@/_shared/helpers/utils'

export const wxLogin = promisify(wx.login)
export const wxCheckSession = promisify(wx.checkSession)
export const wxGetUserProfile = promisify(wx.getUserProfile)
export const wxGetSetting = promisify(wx.getSetting)
export const wxOpenSetting = promisify(wx.openSetting)

// usage example:
// async func() {
//   const { authSetting } = await wxOpenSetting()
// }
```

### SDK ApplyPermission

åœ¨å°ç¨‹åºä¸­ï¼Œå¾ˆå¤šé’ˆå¯¹å®¢æˆ·ç«¯çš„ SDKï¼Œéƒ½éœ€è¦**ç”³è¯·æƒé™**ï¼Œä¾‹å¦‚ï¼šè·å–åœ°ç†ä½ç½®ã€é€‰æ‹©å¾®ä¿¡åœ°å€ã€æ·»åŠ è”ç³»äººåˆ°é€šè®¯å½•ã€ä¿å­˜å›¾ç‰‡è‡³ç›¸å†Œ ç­‰...

æŸäº› SDK ä¸€æ—¦ç”¨æˆ·æ‹’ç»ï¼Œå†æ¬¡è°ƒç”¨æ—¶ä¼šç›´æ¥æŠ¥é”™è€Œä¸ä¼šå†æ‰§è¡Œåé¢çš„é€»è¾‘ï¼Œ

æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¼•å¯¼ç”¨æˆ·æ‰“å¼€å°ç¨‹åº**è®¾ç½®é¡µ**ï¼Œå¼€å¯å¯¹åº”æƒé™ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ `SDK ApplyPermission` ç¤ºä¾‹ï¼š

```js
/**
 * ä¿å­˜å›¾ç‰‡è‡³æ‰‹æœºç›¸å†Œ
 * https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.saveImageToPhotosAlbum.html
 * æ²¿ç”¨ success fail å›è°ƒå‡½æ•°ï¼Œæ˜¯ä¸ºäº†è¦†ç›– sdk é»˜è®¤çš„ toast äº¤äº’æç¤º
 * @param {function} success æ¥å£è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°
 * @param {function} fail æ¥å£è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°
 * @returns {Promise}
 */
export async function saveImageToPhotosAlbum({ success, fail, ...options }) {
  const scope = 'scope.writePhotosAlbum'

  const applyPermissionMsg =
    'æ‚¨æœªå¼€å¯ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œçš„æƒé™ï¼Œè¯·ç‚¹å‡»ç¡®å®šå»å¼€å¯æƒé™ï¼'

  const noPermissionMsg = 'æœªå¼€å¯ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œçš„æƒé™'

  let canIUse = false

  try {
    const { authSetting } = await wxGetSetting()

    // ç”¨æˆ·å·²æ‹’ç»æƒé™ï¼Œåˆ™ä¸º false
    // é¦–æ¬¡ç”³è¯·æƒé™ï¼Œåˆ™ä¸º undefinedï¼Œå¾®ä¿¡ä¼šè‡ªåŠ¨å‘èµ·ä¸€æ¬¡æˆæƒ
    if (authSetting[`${scope}`] === false) {
      // wx.openSetting() å¿…é¡»ç”±ç”¨æˆ· tap è§¦å‘ï¼Œå¿…é¡»å†™ä¸ºåŒæ­¥å‡½æ•°
      wx.showModal({
        title: 'æç¤º',
        content: applyPermissionMsg,
        success: async (res) => {
          if (res.confirm) {
            const { authSetting } = await wxOpenSetting()

            if (authSetting[`${scope}`]) {
              canIUse = true
            } else {
              fail
                ? fail(new SDKException({ message: noPermissionMsg }))
                : wx.showToast({ title: noPermissionMsg, icon: 'none' })
            }
          }
        },
      })
    } else {
      canIUse = true
    }

    if (canIUse) {
      const result = await promisify(wx.saveImageToPhotosAlbum)(options)

      success
        ? success(result)
        : wx.showToast({
            title: 'å›¾ç‰‡å·²ä¿å­˜ç›¸å†Œï¼Œè¯·åœ¨æ‰‹æœºç›¸å†ŒæŸ¥çœ‹',
            icon: 'none',
          })
    }
  } catch (error) {
    // exclude "å–æ¶ˆä¿å­˜" çš„åœºæ™¯
    if (!error.errMsg || error.errMsg.indexOf('fail cancel') === -1) {
      fail
        ? fail(new SDKException(error))
        : wx.showToast({ title: error.errMsg, icon: 'none' })
    }
  }
}
```

ä»¥ä¸Šæ˜¯æˆ‘åœ¨å°ç¨‹åºå®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºæ•°ä¸å¤šä½†åˆè¾ƒä¸ºå¸¸è§çš„ç»éªŒæ€»ç»“ï¼Œåé¢ä¼šæŒç»­æ›´æ–°ï¼Œä¹Ÿæ¬¢è¿ä½ æäº¤ `Pull Request` å’Œæˆ‘ä¸€èµ·å®Œå–„ã€‚
